{"version":3,"sources":["../src/view.js"],"names":["timer","init","cmid","ltiHostname","window","console","log","addEventListener","onMessage","bind","event","origin","URL","hostname","data","type","reload","setHeight","height","updateUUID","uuid","shouldReload","Ajax","call","methodname","args","done","fail","err","error","iframe","document","getElementById","parentNode","removeChild","Notification","alert","Str","get_string","then","modal","getRoot","on","ModalEvents","hidden","location","cap","innerHeight","Math","min","debounce","style","func","clearTimeout","setTimeout"],"mappings":"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","sourcesContent":["/**\n * @package     mod_daddyvideo\n * @copyright   2021 TxC2 <info@txc2.eu>\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Str from 'core/str';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport ModalEvents from 'core/modal_events';\n\nconst PREFIX = 'mod_daddyvideo:';\nlet timer;\n\nexport const init = (cmid, ltiHostname) => {\n    window.console.log(`${PREFIX} Registering message listener...`);\n    window.addEventListener('message', onMessage.bind(this, cmid, ltiHostname));\n};\n\nfunction onMessage(cmid, ltiHostname, event) {\n    const origin = new URL(event.origin).hostname;\n\n    if (origin != ltiHostname) {\n        window.console.log(`${PREFIX} Received message from ${event.origin} but expecting ${ltiHostname}, ignoring`);\n        return;\n    }\n\n    let data = event.data;\n    if (data.type == 'reload') {\n        reload();\n    } else if (data.type == 'resize') {\n        setHeight(data.height);\n    } else {\n        updateUUID(cmid, data);\n    }\n}\n\nfunction updateUUID(cmid, data) {\n    let uuid = '';\n    let shouldReload = false;\n    if (data.type == 'update') {\n        uuid = data.uuid;\n        window.console.log(`${PREFIX} Setting UUID ${uuid} for cmid ${cmid}`);\n    } else if (data.type == 'reset') {\n        window.console.log(`${PREFIX} Resetting cmid ${cmid}`);\n        shouldReload = true;\n    } else {\n        return;\n    }\n\n    Ajax.call([{\n        methodname: \"mod_daddyvideo_set_uuid\",\n        args: {cmid: cmid, uuid: uuid},\n        done: () => {\n            if (shouldReload) {\n                reload();\n            }\n        },\n        fail: (err) => {\n            window.console.error(err);\n\n            // Remove iframe to stop upload\n            const iframe = document.getElementById('daddyvideo-embed');\n            iframe.parentNode.removeChild(iframe);\n\n            // Alert the user and refresh on dismiss\n            Notification.alert(\n                Str.get_string('error_popup_title', 'daddyvideo'),\n                Str.get_string('error_popup_message', 'daddyvideo'),\n                Str.get_string('error_popup_button', 'daddyvideo'))\n                .then(function (modal) {\n                    modal.getRoot().on(ModalEvents.hidden, function () {\n                        shouldReload();\n                    });\n                });\n        }\n    }]);\n}\n\nfunction reload() {\n    window.console.log(`${PREFIX} Reloading...`);\n    window.location.reload(true);\n}\n\nfunction setHeight(height) {\n    let cap = window.innerHeight - 250;\n    height = Math.min(height, cap);\n    debounce(() => {\n        window.console.log(`${PREFIX} Set iframe height to ${height}`);\n    });\n    const iframe = document.getElementById('daddyvideo-embed');\n    iframe.style.height = (height + 25) + 'px';\n}\n\nfunction debounce(func) {\n    clearTimeout(timer);\n    timer = setTimeout(func, 1000);\n}\n"],"file":"view.min.js"}