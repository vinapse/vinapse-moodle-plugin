{"version":3,"sources":["../src/view.js"],"names":["lastRequestedHeight","windowHeight","window","innerHeight","init","cmid","ltiHostname","console","log","addEventListener","onMessage","bind","onWindowResize","event","origin","URL","hostname","data","type","reload","setHeight","height","force","updateUUID","uuid","shouldReload","Ajax","call","methodname","args","done","fail","err","error","iframe","document","getElementById","parentNode","removeChild","Notification","alert","Str","get_string","then","modal","getRoot","on","ModalEvents","hidden","location","max","constrainBetween","style","focus","value","min","Math"],"mappings":"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","sourcesContent":["/**\n * @package     mod_daddyvideo\n * @copyright   2021 TxC2 <info@txc2.eu>\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Str from 'core/str';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport ModalEvents from 'core/modal_events';\n\nconst PREFIX = 'mod_daddyvideo:';\nlet lastRequestedHeight = null;\nlet windowHeight = window.innerHeight;\n\nexport const init = (cmid, ltiHostname) => {\n    window.console.log(`${PREFIX} Registering message listener...`);\n    window.addEventListener('message', onMessage.bind(this, cmid, ltiHostname));\n    window.addEventListener('resize', onWindowResize);\n};\n\nfunction onMessage(cmid, ltiHostname, event) {\n    const origin = new URL(event.origin).hostname;\n\n    if (origin != ltiHostname) {\n        window.console.log(`${PREFIX} Received message from ${event.origin} but expecting ${ltiHostname}, ignoring`);\n        return;\n    }\n\n    let data = event.data;\n    if (data.type == 'reload') {\n        reload();\n    } else if (data.type == 'resize') {\n        setHeight(data.height, data.force);\n    } else {\n        updateUUID(cmid, data);\n    }\n}\n\nfunction updateUUID(cmid, data) {\n    let uuid = '';\n    let shouldReload = false;\n    if (data.type == 'update') {\n        uuid = data.uuid;\n        window.console.log(`${PREFIX} Setting UUID ${uuid} for cmid ${cmid}`);\n    } else if (data.type == 'reset') {\n        window.console.log(`${PREFIX} Resetting cmid ${cmid}`);\n        shouldReload = true;\n    } else {\n        return;\n    }\n\n    Ajax.call([{\n        methodname: \"mod_daddyvideo_set_uuid\",\n        args: {cmid: cmid, uuid: uuid},\n        done: () => {\n            if (shouldReload) {\n                reload();\n            }\n        },\n        fail: (err) => {\n            window.console.error(err);\n\n            // Remove iframe to stop upload\n            const iframe = document.getElementById('vinapse-embed');\n            iframe.parentNode.removeChild(iframe);\n\n            // Alert the user and refresh on dismiss\n            Notification.alert(\n                Str.get_string('error_popup_title', 'daddyvideo'),\n                Str.get_string('error_popup_message', 'daddyvideo'),\n                Str.get_string('error_popup_button', 'daddyvideo'))\n                .then(function (modal) {\n                    modal.getRoot().on(ModalEvents.hidden, function () {\n                        shouldReload();\n                    });\n                });\n        }\n    }]);\n}\n\nfunction reload() {\n    window.console.log(`${PREFIX} Reloading...`);\n    window.location.reload(true);\n}\n\nfunction onWindowResize() {\n    if (lastRequestedHeight && window.innerHeight != windowHeight) {\n        windowHeight = window.innerHeight;\n        setHeight(lastRequestedHeight, false);\n    }\n}\n\nfunction setHeight(height, force) {\n    if (!force) {\n        lastRequestedHeight = height;\n        let min = 300;\n        let max = window.innerHeight - 270;\n        height = constrainBetween(height, min, max);\n    } else {\n        lastRequestedHeight = null;\n    }\n\n    const iframe = document.getElementById('vinapse-embed');\n    iframe.style.height = `${height}px`;\n    iframe.focus();\n}\n\nfunction constrainBetween(value, min, max) {\n    value = Math.min(value, max);\n    value = Math.max(value, min);\n    return value;\n}\n"],"file":"view.min.js"}