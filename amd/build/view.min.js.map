{"version":3,"file":"view.min.js","sources":["../src/view.js"],"sourcesContent":["/**\n * @copyright   2021 TxC2 <info@txc2.eu>\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Str from 'core/str';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport ModalEvents from 'core/modal_events';\n\nconst PREFIX = 'mod_vinapse:';\nlet lastRequestedHeight = null;\nlet windowHeight = window.innerHeight;\n\n/**\n * Initializes the module.\n * @param {number} cmid The course module id\n * @param {string} ltiHostname - The hostname of the LTI provider\n */\nexport const init = (cmid, ltiHostname) => {\n    window.console.log(`${PREFIX} Registering message listener...`);\n    window.addEventListener('message', onMessage.bind(this, cmid, ltiHostname));\n    window.addEventListener('resize', onWindowResize);\n};\n\n/**\n * Handles messages from the LTI provider iframe.\n * @param {number} cmid - The course module id\n * @param {string} ltiHostname - The hostname of the LTI provider\n * @param {MessageEvent} event - The message event\n */\nfunction onMessage(cmid, ltiHostname, event) {\n    const origin = new URL(event.origin).hostname;\n\n    if (origin !== ltiHostname) {\n        window.console.log(`${PREFIX} Received message from ${event.origin} but expecting ${ltiHostname}, ignoring`);\n        return;\n    }\n\n    let data = event.data;\n    if (data.type === 'reload') {\n        reload();\n    } else if (data.type === 'resize') {\n        setHeight(data.height, data.force);\n    } else {\n        updateUUID(cmid, data);\n    }\n}\n\n/**\n * Updates the UUID of the current course module through an AJAX call.\n * @param {number} cmid - The course module id\n * @param {object} data - The message received from the LTI provider\n */\nfunction updateUUID(cmid, data) {\n    let uuid = '';\n    let shouldReload = false;\n    if (data.type === 'update') {\n        uuid = data.uuid;\n        window.console.log(`${PREFIX} Setting UUID ${uuid} for cmid ${cmid}`);\n    } else if (data.type === 'reset') {\n        window.console.log(`${PREFIX} Resetting cmid ${cmid}`);\n        shouldReload = true;\n    } else {\n        return;\n    }\n\n    Ajax.call([{\n        methodname: 'mod_vinapse_set_uuid',\n        args: {cmid: cmid, uuid: uuid},\n        done: () => {\n            if (shouldReload) {\n                reload();\n            }\n        },\n        fail: (err) => {\n            window.console.error(err);\n\n            // Remove iframe to stop upload\n            const iframe = document.getElementById('vinapse-embed');\n            iframe.parentNode.removeChild(iframe);\n\n            // Alert the user and refresh on dismiss\n            Notification.alert(\n                Str.get_string('error_popup_title', 'vinapse'),\n                Str.get_string('error_popup_message', 'vinapse'),\n                Str.get_string('error_popup_button', 'vinapse'))\n                .then(function (modal) {\n                    modal.getRoot().on(ModalEvents.hidden, function () {\n                        shouldReload();\n                    });\n                });\n        }\n    }]);\n}\n\n/**\n * Reloads the page.\n */\nfunction reload() {\n    window.console.log(`${PREFIX} Reloading...`);\n    window.location.reload(true);\n}\n\n/**\n * Handles window resize events.\n */\nfunction onWindowResize() {\n    if (lastRequestedHeight && window.innerHeight != windowHeight) {\n        windowHeight = window.innerHeight;\n        setHeight(lastRequestedHeight, false);\n    }\n}\n\n/**\n * Sets the height of the iframe.\n * @param {number} height - The height to set\n * @param {boolean} force - Whether to force the height, overriding constraints\n */\nfunction setHeight(height, force) {\n    if (!force) {\n        lastRequestedHeight = height;\n        let min = 300;\n        let max = window.innerHeight - 270;\n        height = constrainBetween(height, min, max);\n    } else {\n        lastRequestedHeight = null;\n    }\n\n    const iframe = document.getElementById('vinapse-embed');\n    iframe.style.height = `${height}px`;\n    iframe.focus();\n}\n\n/**\n * Constrains a value between a minimum and maximum value.\n * @param {number} value\n * @param {number} min\n * @param {number} max\n * @returns {number}\n */\nfunction constrainBetween(value, min, max) {\n    value = Math.min(value, max);\n    value = Math.max(value, min);\n    return value;\n}\n"],"names":["PREFIX","lastRequestedHeight","windowHeight","window","innerHeight","onMessage","cmid","ltiHostname","event","URL","origin","hostname","console","log","data","type","reload","setHeight","height","force","uuid","shouldReload","call","methodname","args","done","fail","err","error","iframe","document","getElementById","parentNode","removeChild","alert","Str","get_string","then","modal","getRoot","on","ModalEvents","hidden","updateUUID","location","onWindowResize","value","min","max","Math","constrainBetween","style","focus","addEventListener","bind"],"mappings":";;;;6JAUMA,OAAS,mBACXC,oBAAsB,KACtBC,aAAeC,OAAOC,qBAmBjBC,UAAUC,KAAMC,YAAaC,UACnB,IAAIC,IAAID,MAAME,QAAQC,WAEtBJ,wBACXJ,OAAOS,QAAQC,cAAOb,yCAAgCQ,MAAME,iCAAwBH,+BAIpFO,KAAON,MAAMM,KACC,WAAdA,KAAKC,KACLC,SACqB,WAAdF,KAAKC,KACZE,UAAUH,KAAKI,OAAQJ,KAAKK,gBAWhBb,KAAMQ,UAClBM,KAAO,GACPC,cAAe,KACD,WAAdP,KAAKC,KACLK,KAAON,KAAKM,KACZjB,OAAOS,QAAQC,cAAOb,gCAAuBoB,0BAAiBd,WAC3D,CAAA,GAAkB,UAAdQ,KAAKC,YACZZ,OAAOS,QAAQC,cAAOb,kCAAyBM,OAC/Ce,cAAe,gBAKdC,KAAK,CAAC,CACPC,WAAY,uBACZC,KAAM,CAAClB,KAAMA,KAAMc,KAAMA,MACzBK,KAAM,KACEJ,cACAL,UAGRU,KAAOC,MACHxB,OAAOS,QAAQgB,MAAMD,WAGfE,OAASC,SAASC,eAAe,iBACvCF,OAAOG,WAAWC,YAAYJ,8BAGjBK,MACTC,IAAIC,WAAW,oBAAqB,WACpCD,IAAIC,WAAW,sBAAuB,WACtCD,IAAIC,WAAW,qBAAsB,YACpCC,MAAK,SAAUC,OACZA,MAAMC,UAAUC,GAAGC,sBAAYC,QAAQ,WACnCrB,yBA5ChBsB,CAAWrC,KAAMQ,eAsDhBE,SACLb,OAAOS,QAAQC,cAAOb,yBACtBG,OAAOyC,SAAS5B,QAAO,YAMlB6B,iBACD5C,qBAAuBE,OAAOC,aAAeF,eAC7CA,aAAeC,OAAOC,YACtBa,UAAUhB,qBAAqB,aAS9BgB,UAAUC,OAAQC,UAClBA,MAMDlB,oBAAsB,SANd,CACRA,oBAAsBiB,OAGtBA,gBAiBkB4B,MAAOC,IAAKC,YAClCF,MAAQG,KAAKF,IAAID,MAAOE,KACxBF,MAAQG,KAAKD,IAAIF,MAAOC,KAnBXG,CAAiBhC,OAFhB,IACAf,OAAOC,YAAc,WAM7ByB,OAASC,SAASC,eAAe,iBACvCF,OAAOsB,MAAMjC,iBAAYA,aACzBW,OAAOuB,sBAhHS,CAAC9C,KAAMC,eACvBJ,OAAOS,QAAQC,cAAOb,4CACtBG,OAAOkD,iBAAiB,UAAWhD,UAAUiD,YAAWhD,KAAMC,cAC9DJ,OAAOkD,iBAAiB,SAAUR"}